---
title:  "Browser"
date:   2019-05-22 16:17:00
categories: [blog]
tags: [Browser]
---

- 获取节点宽度问题  
```html
<div id="root" style="width: 200px; border: 2px solid; /*box-sizing: border-box*/">
  <div id="content" style="width: 300px">
  </div>
</div>
<script>
var root = document.getElementById('root');
var clientWidth = root.clientWidth; // 200px 196px
var offsetWidth = root.offsetWidth; // 204px 200px
var scrollWidth = root.scrollWidth; // 300px 300px
// 判断是否处在mac系统中
function isMac() {
  return /macintosh|mac os x/i.test(navigator.userAgent);
}
</script>
```
clientWidth=width+padding  
offsetWidth=width+padding+border  
scrollWidth=滚动距离  
当出现垂直滚动条时，滚动条宽度通常宽度为17px，它会占据节点盒子模型的宽度，进而影响到节点实际展示的宽度，即我们用DevTool审查元素时的到的宽度为183px，而实际获得的clientWidth/offsetWidth为200px，但是这在Mac系统又不存在，因为Mac系统的Chrome滚动条不会占据节点盒子模型的宽度。

### 浏览器帧
理想的帧数是60FPS，也就是1m60帧，16.67ms一帧。每一帧的执行内容如下图所示：
![](/images/2019-05-22-browser/5.png) 
每帧执行完时浏览器的GPU线程会将需要渲染的内容发送给计算机的GPU，最终显示在屏幕上。

### 浏览器中的Idle时间是哪来的
推测：参照上图，当每帧的执行内容在16.67ms内执行完成，在发送给计算机的GPU后～下一帧开始（计算机的GPU渲染完应该会反馈给浏览器触使开始下一帧）会有空档期，也就是Idle，浏览器就会执行requestIdleCallback方法，极端的静态页面，它的每帧Idle时间就会接近16.67ms。

### 时间分片
时间分片的核心思想就是把一帧当中的耗时任务合理切分到多帧中执行。
因为当某一帧的JS中有一段很耗时的同步任务，最终导致帧任务耗时超过了16.67ms，计算机的GPU渲染并不会等待浏览器，最终导致丢帧。
时间分片通常会使用requestAnimateFrame而不是setTimeout/setInterval，前者会保证在下一帧重绘重排前执行，后者不能保证后续帧连续执行。

### viewport
viewport分为layout viewport，visual viewport，ideal viewport，注意这些都是指独立像素而非物理像素/手机尺寸   
- PC浏览器的layout viewport是严格等于浏览器窗口的，移动端浏览器为了能够适应PC的网站，把layout viewport默认设置为980px，这样即使页面是按百分比布局，在移动端显示时也不会极度变形，可以通过document.documentElement.clientWidth得到layout viewport值；
![](/images/2019-05-22-browser/1.png) 
- visual viewport决定可视区域大小，可视区域大小可随浏览器缩放而变化，PC浏览器的visual viewport默认等于layout viewport，可以通过window.innerWidth得到visual viewport的值； 
![](/images/2019-05-22-browser/2.png)  
- ideal viewport是每个手机厂商设定的一个理想大小，所谓的理想是指不需要用户缩放和横向滚动条就能正常的查看网站的所有内容，显示的文字的大小是合适（确定仅靠手机浏览器支持而不需要开发者适配？），每个手机厂商设置的不一定一样，比如苹果手机都为320px。  
meta的viewport属性中，
- width是来控制layout viewport的，当width=device-width时表示把layout viewport设置为ideal viewport，不过在iphone和ipad上，无论是竖屏还是横屏，宽度都是竖屏时ideal viewport的宽度；
![](/images/2019-05-22-browser/3.png)  
- initial-scale表示初始的缩放比，它是相对于ideal viewport的，所以当initial-scale=1时，等价于width=device-width，公式为layout viewport = ideal viewport / initial-scale；
![](/images/2019-05-22-browser/4.png)  
- 当width和initial-scale同时出现时，浏览器会取较大值作为layout viewport，并同时解决了兼容问题。
- devicePixelRatio为设备物理像素和设备独立像素的比例，devicePixelRatio = 物理像素 / 独立像素，CSS中的px代表的就是这独立像素。
- visual viewport = ideal viewport / 当前缩放值
- 当前缩放值 = ideal viewport / visual viewport
- initial-scale在安卓机中没有默认值，只有设置了initial-scale才会生效，在苹果系列中，会自动计算initial-scale这个值，以保证visual viewport中能完全展现layout viewport，也就是说不会出现横向滚动条，那么此时的visual viewport=layout viewport=980，即initial-scale = 320 / 980
- 当initial-scale=0时代表什么？

