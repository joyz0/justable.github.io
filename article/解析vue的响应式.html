<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å¬é±¼çš„åšå®¢</title>
    <meta name="description" content="éšä¾¿ç©ç©">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.341cfc29.css" as="style"><link rel="preload" href="/assets/js/app.5be931bc.js" as="script"><link rel="preload" href="/assets/js/2.448a10a4.js" as="script"><link rel="preload" href="/assets/js/8.04576c8f.js" as="script"><link rel="prefetch" href="/assets/js/10.02a243ba.js"><link rel="prefetch" href="/assets/js/11.07a31d75.js"><link rel="prefetch" href="/assets/js/12.310a8227.js"><link rel="prefetch" href="/assets/js/13.f50c6935.js"><link rel="prefetch" href="/assets/js/14.09a0c4c6.js"><link rel="prefetch" href="/assets/js/15.8e51dd21.js"><link rel="prefetch" href="/assets/js/16.65281bdd.js"><link rel="prefetch" href="/assets/js/17.b0f1585f.js"><link rel="prefetch" href="/assets/js/18.824bb3a9.js"><link rel="prefetch" href="/assets/js/19.ffbf340b.js"><link rel="prefetch" href="/assets/js/20.695f97f4.js"><link rel="prefetch" href="/assets/js/21.881aca87.js"><link rel="prefetch" href="/assets/js/22.951e6748.js"><link rel="prefetch" href="/assets/js/23.4ab10843.js"><link rel="prefetch" href="/assets/js/24.faa072fe.js"><link rel="prefetch" href="/assets/js/25.b0b1cf54.js"><link rel="prefetch" href="/assets/js/26.f3b05f32.js"><link rel="prefetch" href="/assets/js/27.c94152c1.js"><link rel="prefetch" href="/assets/js/28.3a98ff88.js"><link rel="prefetch" href="/assets/js/29.e1799199.js"><link rel="prefetch" href="/assets/js/3.9641240d.js"><link rel="prefetch" href="/assets/js/30.865376e6.js"><link rel="prefetch" href="/assets/js/31.28b89d2d.js"><link rel="prefetch" href="/assets/js/32.eafc6b11.js"><link rel="prefetch" href="/assets/js/33.c77cab20.js"><link rel="prefetch" href="/assets/js/34.9cce1d5d.js"><link rel="prefetch" href="/assets/js/35.1712911f.js"><link rel="prefetch" href="/assets/js/36.ff764ca1.js"><link rel="prefetch" href="/assets/js/37.0bd60ea1.js"><link rel="prefetch" href="/assets/js/38.f18839bc.js"><link rel="prefetch" href="/assets/js/39.40cdcb78.js"><link rel="prefetch" href="/assets/js/4.cd42c258.js"><link rel="prefetch" href="/assets/js/40.1eb18f5f.js"><link rel="prefetch" href="/assets/js/41.9307ab9d.js"><link rel="prefetch" href="/assets/js/42.352fba7f.js"><link rel="prefetch" href="/assets/js/43.2f5674ae.js"><link rel="prefetch" href="/assets/js/44.e4018814.js"><link rel="prefetch" href="/assets/js/45.30b881d4.js"><link rel="prefetch" href="/assets/js/46.d074a2c4.js"><link rel="prefetch" href="/assets/js/47.0c922602.js"><link rel="prefetch" href="/assets/js/48.f7f9e4b2.js"><link rel="prefetch" href="/assets/js/49.4037f274.js"><link rel="prefetch" href="/assets/js/5.842332c1.js"><link rel="prefetch" href="/assets/js/50.594622eb.js"><link rel="prefetch" href="/assets/js/51.7d56cb21.js"><link rel="prefetch" href="/assets/js/52.87b13220.js"><link rel="prefetch" href="/assets/js/53.751f2798.js"><link rel="prefetch" href="/assets/js/54.29cc8b60.js"><link rel="prefetch" href="/assets/js/55.8df39c4a.js"><link rel="prefetch" href="/assets/js/56.51481b3e.js"><link rel="prefetch" href="/assets/js/57.46d3719b.js"><link rel="prefetch" href="/assets/js/58.8dd43329.js"><link rel="prefetch" href="/assets/js/59.f1025e25.js"><link rel="prefetch" href="/assets/js/6.deadcc43.js"><link rel="prefetch" href="/assets/js/60.b544d47b.js"><link rel="prefetch" href="/assets/js/61.f16f2821.js"><link rel="prefetch" href="/assets/js/62.43c835fd.js"><link rel="prefetch" href="/assets/js/63.71e154bc.js"><link rel="prefetch" href="/assets/js/64.3eb70331.js"><link rel="prefetch" href="/assets/js/65.4516dcd8.js"><link rel="prefetch" href="/assets/js/66.1df88cb3.js"><link rel="prefetch" href="/assets/js/67.25e55733.js"><link rel="prefetch" href="/assets/js/68.248cb296.js"><link rel="prefetch" href="/assets/js/69.ec7d3469.js"><link rel="prefetch" href="/assets/js/7.dd05edae.js"><link rel="prefetch" href="/assets/js/70.974d559e.js"><link rel="prefetch" href="/assets/js/71.160e2afe.js"><link rel="prefetch" href="/assets/js/72.bf293cd2.js"><link rel="prefetch" href="/assets/js/73.17c3960b.js"><link rel="prefetch" href="/assets/js/74.255c8916.js"><link rel="prefetch" href="/assets/js/75.3309d84e.js"><link rel="prefetch" href="/assets/js/76.c7290121.js"><link rel="prefetch" href="/assets/js/77.282aab06.js"><link rel="prefetch" href="/assets/js/78.916dd1f4.js"><link rel="prefetch" href="/assets/js/79.5f753590.js"><link rel="prefetch" href="/assets/js/80.84145567.js"><link rel="prefetch" href="/assets/js/81.6ab8470d.js"><link rel="prefetch" href="/assets/js/9.7569a793.js">
    <link rel="stylesheet" href="/assets/css/0.styles.341cfc29.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">å¬é±¼çš„åšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/article/æµ…è°ˆJSä¸­çš„AST.html" class="nav-link">
  æ–‡ç« 
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="åŸºç¡€çŸ¥è¯†" class="dropdown-title"><span class="title">åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/html5/BrowsingContext.html" class="nav-link">
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/basic/css3/flex.html" class="nav-link">
  CSS3
</a></li><li class="dropdown-item"><!----> <a href="/basic/javascript/closure.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basic/nodejs/å¸¸ç”¨NPMåŒ…ç´¢å¼•.html" class="nav-link">
  NodeJS
</a></li><li class="dropdown-item"><!----> <a href="/basic/typescript/basic.html" class="nav-link">
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/basic/browser/cors.html" class="nav-link">
  Browser
</a></li><li class="dropdown-item"><!----> <a href="/basic/webpack/webpack4.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/basic/react/react-kernel.html" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/basic/vue/vue-loader.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/basic/network/TCPIP.html" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/basic/git/command.html" class="nav-link">
  Git
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/justable/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/article/æµ…è°ˆJSä¸­çš„AST.html" class="nav-link">
  æ–‡ç« 
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="åŸºç¡€çŸ¥è¯†" class="dropdown-title"><span class="title">åŸºç¡€çŸ¥è¯†</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/basic/html5/BrowsingContext.html" class="nav-link">
  HTML5
</a></li><li class="dropdown-item"><!----> <a href="/basic/css3/flex.html" class="nav-link">
  CSS3
</a></li><li class="dropdown-item"><!----> <a href="/basic/javascript/closure.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/basic/nodejs/å¸¸ç”¨NPMåŒ…ç´¢å¼•.html" class="nav-link">
  NodeJS
</a></li><li class="dropdown-item"><!----> <a href="/basic/typescript/basic.html" class="nav-link">
  TypeScript
</a></li><li class="dropdown-item"><!----> <a href="/basic/browser/cors.html" class="nav-link">
  Browser
</a></li><li class="dropdown-item"><!----> <a href="/basic/webpack/webpack4.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/basic/react/react-kernel.html" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/basic/vue/vue-loader.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/basic/network/TCPIP.html" class="nav-link">
  Network
</a></li><li class="dropdown-item"><!----> <a href="/basic/git/command.html" class="nav-link">
  Git
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/justable/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/article/æµ…è°ˆJSä¸­çš„AST.html" class="sidebar-link">æµ…è°ˆJSä¸­çš„AST</a></li><li><a href="/article/å®ç°ä¸€ä¸ªç®€å•çš„WEBæ‰“åŒ…å·¥å…·.html" class="sidebar-link">å®ç°ä¸€ä¸ªç®€å•çš„WEBæ‰“åŒ…å·¥å…·</a></li><li><a href="/article/è§£ævueçš„å“åº”å¼.html" class="active sidebar-link">è§£ævueçš„å“åº”å¼</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/article/è§£ævueçš„å“åº”å¼.html#vue-next-æ¦‚è¿°" class="sidebar-link">vue-next æ¦‚è¿°</a></li><li class="sidebar-sub-header"><a href="/article/è§£ævueçš„å“åº”å¼.html#reactive-ts" class="sidebar-link">reactive.ts</a></li><li class="sidebar-sub-header"><a href="/article/è§£ævueçš„å“åº”å¼.html#effect-ts" class="sidebar-link">effect.ts</a></li><li class="sidebar-sub-header"><a href="/article/è§£ævueçš„å“åº”å¼.html#computed-ts" class="sidebar-link">computed.ts</a></li><li class="sidebar-sub-header"><a href="/article/è§£ævueçš„å“åº”å¼.html#ref-ts" class="sidebar-link">ref.ts</a></li><li class="sidebar-sub-header"><a href="/article/è§£ævueçš„å“åº”å¼.html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>ä½¿ç”¨ vue çš„æ—¶å€™ï¼Œå¯¹å…¶çš„æ•°æ®å“åº”å¼ä¸€ç›´å¾ˆå¥½å¥‡ï¼Œå®ƒçš„å“åº”å¼æ˜¯ mutable çš„ï¼Œæˆ‘ä»¬åªéœ€æ”¹å˜ data ä¸­å˜é‡çš„å€¼ï¼Œvue å°±ä¼šæ›´æ–°ç›¸åº”çš„è§†å›¾ï¼Œè¿™å’Œ react ä¸åŒï¼Œreact çš„ state æ˜¯ immutable çš„ï¼Œéœ€è¦æ˜¾å¼çš„ setState æ‰ä¼šå‘èµ·ä¸€è½®æ–°çš„ Reconciliationã€‚</p> <p>react çš„è¿™ç§æ¨¡å¼å¯èƒ½æ›´ç›´è§‚ï¼Œvue çš„æ¨¡å¼æœ‰ç§é»‘é­”æ³•çš„å‘³é“ ğŸ˜œã€‚æœ¬æ–‡å°±æ¥åˆ†æä¸‹è¿™ä¸ªé»‘é­”æ³•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå› ä¸ºæœ€è¿‘ vue 3 çš„<a href="https://github.com/vuejs/vue-next" target="_blank" rel="noopener noreferrer">æºç <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>å·²ç»å…¬å¸ƒï¼Œæ‰€ä»¥å°±çœ‹ vue 3 çš„æºç å§ã€‚</p> <p>åœ¨åˆ†ææºç ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€çœ‹æœ€ç»ˆçš„æ•ˆæœï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">let</span> dummy<span class="token punctuation">;</span>
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

counter<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>è¿™æ˜¯ä¸€æ®µå•å…ƒæµ‹è¯•ï¼Œé€šè¿‡ reactive åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ counterï¼Œé€šè¿‡ effect æ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°å†…éƒ¨è®¿é—®äº† counter çš„ num å±æ€§ï¼Œå½“æ”¹å˜ counter.num æ—¶ï¼Œä½¿ç”¨åˆ°å®ƒçš„å‡½æ•°å°±è‡ªåŠ¨è¢«æ‰§è¡Œäº†ã€‚å…¶å®ä¸Šè¿°çŸ­çŸ­çš„ä¸€ä¸ªå•å…ƒæµ‹è¯•ï¼Œå·²ç»å±•ç°äº† vue æ•°æ®å“åº”æœºåˆ¶çš„é›å½¢ï¼Œåªéœ€æŠŠ data è¿›è¡Œ reactiveï¼Œå†æŠŠæ¸²æŸ“å‡½æ•°æ³¨å†Œåœ¨ effect ä¸­ï¼Œæˆ‘ä»¬å¯¹ data çš„æ‰€æœ‰æ”¹å˜å°±èƒ½è‡ªåŠ¨è§¦å‘è§†å›¾é‡ç»˜äº†ã€‚</p> <p>æœ¬æ–‡ä¸»è¦ä¼šåˆ†æ reactive å’Œ effect çš„å®ç°ï¼ŒåŒæ—¶ä¹Ÿä¼šæåŠ computed çš„å®ç°ï¼Œè¿˜æœ‰ vue 3 æ–°å¢çš„ ref å¯¹è±¡--ä¸€ä¸ªåªä»£ç† value å±æ€§çš„å¯¹è±¡ã€‚</p> <h2 id="vue-next-æ¦‚è¿°"><a href="#vue-next-æ¦‚è¿°" class="header-anchor">#</a> vue-next æ¦‚è¿°</h2> <p>vue 3 çš„ github ä»“åº“å®˜æ–¹æš‚æ—¶å–åä¸º vue-nextï¼Œå®ƒå¼€å¯äº† yarn çš„ workspaces è¿›è¡Œå¤šåŒ…ç®¡ç†ï¼Œè¿™ç§é¡¹ç›®ç»„ç»‡å½¢å¼å¯ä»¥ç§°å‘¼ä¸º <a href="https://github.com/babel/babel/blob/master/doc/design/monorepo.md" target="_blank" rel="noopener noreferrer">monorepos<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œå¹¶ä¸”ä½¿ç”¨ TypeScript ä½œä¸ºç±»å‹ç³»ç»Ÿæ›¿æ¢äº†åŸæœ¬çš„ Flowã€‚</p> <p>ç›®å½•ç»“æ„ï¼š</p> <p><img src="/assets/img/vue_next_dir.67ff6caf.png" alt=""></p> <p>æœ¬æ–‡è¦è®²çš„ reactiveã€effectã€computedã€ref éƒ½åœ¨ reactivity åŒ…ä¸­ã€‚</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>ä¼šæ¶‰åŠåˆ° WeakMapã€WeakSetã€Proxyã€Reflect ç­‰ ES6+çš„çŸ¥è¯†ï¼Œè¯·å…ˆè¡Œäº†è§£å­¦ä¹ ã€‚</p></div> <h2 id="reactive-ts"><a href="#reactive-ts" class="header-anchor">#</a> reactive.ts</h2> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// çœç•¥...</span>
  <span class="token keyword">return</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
    <span class="token comment">// åŸå§‹å¯¹è±¡</span>
    target<span class="token punctuation">,</span>
    <span class="token comment">// ä¸€ä¸ªå­˜å‚¨åŸå§‹å¯¹è±¡-&gt;å“åº”å¼å¯¹è±¡çš„WeakMap</span>
    rawToReactive<span class="token punctuation">,</span>
    <span class="token comment">// ä¸€ä¸ªå­˜å‚¨å“åº”å¼å¯¹è±¡-&gt;åŸå§‹å¯¹è±¡çš„WeakMap</span>
    reactiveToRaw<span class="token punctuation">,</span>
    mutableHandlers<span class="token punctuation">,</span>
    mutableCollectionHandlers
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createReactiveObject</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  toProxy<span class="token operator">:</span> WeakMap<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  toRaw<span class="token operator">:</span> WeakMap<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  baseHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  collectionHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// çœç•¥...</span>
  <span class="token comment">// å¦‚æœtargetæ˜¯Mapã€Setã€WeakMapã€WeakSetçš„å®ä¾‹ï¼Œä½¿ç”¨ä¸åŒçš„handler</span>
  <span class="token keyword">const</span> handlers <span class="token operator">=</span> collectionTypes<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token keyword">constructor</span><span class="token punctuation">)</span>
    <span class="token operator">?</span> collectionHandlers
    <span class="token operator">:</span> baseHandlers<span class="token punctuation">;</span>
  <span class="token comment">// åˆ›å»ºProxy</span>
  observed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  toProxy<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> observed<span class="token punctuation">)</span><span class="token punctuation">;</span>
  toRaw<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>observed<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> observed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>ä¸Šè¿°ä»£ç å°±æ˜¯ reactive çš„æ ¸å¿ƒé€»è¾‘ï¼Œè™½ç„¶æ¶‰åŠåˆ°äº†å¾ˆå¤šå˜é‡ï¼Œå…¶å®çœŸæ­£çš„ä¸»é€»è¾‘å°±ä¸€è¡Œ<code>return observed = new Proxy(target, handlers)</code>ï¼ŒrawToReactive å’Œ reactiveToRaw æ˜¯ç”¨æ¥åšè®°å½•çš„ï¼Œå…¶ä¸­çš„ raw æœ‰åŸå§‹æœªåŠ å·¥è¿‡çš„æ„æ€ã€‚</p> <p>æˆ‘ä»¬æ³¨æ„åˆ°å½“ target æ˜¯é›†åˆçš„å®ä¾‹æ—¶ï¼Œä»£ç åšäº†ç‰¹æ®Šå¤„ç†ï¼Œç›®çš„æ˜¯è¦ä»£ç† Mapã€Setã€WeakMapã€WeakSet è¿™äº›é›†åˆçš„ apiï¼Œä½†ä¸ºä»€ä¹ˆè¦ç‰¹æ®Šå¤„ç†å‘¢ï¼Ÿæ˜¯å› ä¸ºè°ƒç”¨é›†åˆ api æ—¶ä¼šè§¦å‘ Proxy handler çš„ get æ–¹æ³•ï¼Œget æ–¹æ³•ä¸­æ¥æ”¶åˆ°çš„ key å°±æ˜¯å¯¹åº” api çš„åç§°ï¼Œæ¯”å¦‚ new Map().set('foo', 'foo')ï¼Œå®ƒä¼šè§¦å‘ get ä¸”æ¥æ”¶åˆ°çš„ key=setï¼Œä½†ä¸ä¼šè§¦å‘ handler ä¸­çš„ set æ–¹æ³•ã€‚æœ‰çš„åŒå­¦å¯èƒ½ä¼šè”æƒ³åˆ° new Array().push('foo')ï¼Œå®ƒä¼šè§¦å‘ get ä¸”æ¥æ”¶åˆ°çš„ key=pushï¼ŒåŒºåˆ«æ˜¯åŒæ—¶ä¼šè§¦å‘ handler ä¸­çš„ set æ–¹æ³•ï¼Œkey=å½“å‰æ•°ç»„ä¸‹æ ‡ã€‚</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>å¦‚æœä¸æ¸…æ¥š Proxy çš„è¯å¾ˆéš¾ç†è§£ä¸Šé¢è¿™æ®µè¯ï¼Œä¸è¿‡ä¸å½±å“ä¸»é€»è¾‘</p></div> <p>æˆ‘ä»¬å°±å¿½ç•¥é›†åˆç±»å‹å§ï¼Œçœ‹æ­£å¸¸çš„ handler æ˜¯é•¿ä»€ä¹ˆæ ·çš„ï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> mutableHandlers<span class="token operator">:</span> ProxyHandler<span class="token operator">&lt;</span>object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// è¯»å–å±æ€§æ—¶è§¦å‘</span>
  <span class="token keyword">get</span><span class="token punctuation">,</span>
  <span class="token comment">// èµ‹å€¼æ—¶è§¦å‘</span>
  <span class="token keyword">set</span><span class="token punctuation">,</span>
  <span class="token comment">// åˆ é™¤å±æ€§æ—¶è§¦å‘</span>
  deleteProperty<span class="token punctuation">,</span>
  <span class="token comment">// åœ¨æ˜¯å¦æ‹¥æœ‰æŸä¸ªå±æ€§æ—¶è§¦å‘ï¼Œæ¯”å¦‚&quot;foo&quot; in proxy</span>
  has<span class="token punctuation">,</span>
  <span class="token comment">// Object.getOwnPropertyNames()æ—¶è§¦å‘</span>
  ownKeys
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ get å’Œ setï¼Œå› ä¸º vue ä¼šåœ¨ get ä¸­æ”¶é›†å¯¹è±¡å±æ€§æ‰€ç›¸å…³è”çš„ effectï¼Œåœ¨ set ä¸­è§¦å‘å¹¶è°ƒç”¨è¿™äº› effectï¼Œæ¢å¥è¯è¯´ï¼Œå½“ä¸€ä¸ª effect ä¸­ä½¿ç”¨åˆ°äº†ä»£ç†å¯¹è±¡ï¼Œè‡ªç„¶å°±è§¦å‘äº†è¿™ä¸ªä»£ç†å¯¹è±¡çš„ getï¼Œæ­¤æ—¶å°±èƒ½æŠŠè¿™ä¸ªæ­£åœ¨æ‰§è¡Œçš„ effect å’Œä»£ç†å¯¹è±¡å…³è”å¹¶è®°å½•ä¸‹æ¥ï¼Œä¸‹æ¬¡ä»£ç†å¯¹è±¡çš„å±æ€§å‘ç”Ÿæ”¹å˜æ—¶è‡ªç„¶è§¦å‘äº† setï¼Œä¹Ÿå°±è§¦å‘å¹¶è°ƒç”¨äº†é‚£äº›å·²å…³è”çš„ effectã€‚</p> <h3 id="creategetter"><a href="#creategetter" class="header-anchor">#</a> createGetter</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">createGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> receiver<span class="token operator">:</span> object</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">:</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>ä¸Šé¢å°±æ˜¯ get çš„å®ç°ï¼Œä¸ºäº†æ‹æ¸…ä¸»é€»è¾‘ï¼Œæˆ‘æŠŠä»£ç ä¸­å¤„ç†åªè¯»æ¨¡å¼ã€æµ…å“åº”æ¨¡å¼çš„éƒ¨åˆ†åˆ é™¤äº†ã€‚æ³¨æ„<code>isObject(res) ? reactive(res) : res</code>è¿™æ®µä»£ç ï¼Œå…¶å†…å«äº†é€’å½’é€»è¾‘ï¼Œç›®çš„æ˜¯æŠŠå¯¹è±¡ä¸­çš„æ‰€æœ‰å†…åµŒå­å¯¹è±¡éƒ½åŒ…è£…æˆä»£ç†å¯¹è±¡ã€‚ä¸Šé¢çš„ track æ–¹æ³•ç”¨æ¥è¿½è¸ªå½“å‰è¯»å–çš„ key æ‰€å¯¹åº”çš„ effect å‡½æ•°ï¼Œæœ‰çš„åŒå­¦å¯èƒ½å¼€å§‹å›°æƒ‘äº†ï¼Œå°±è¿™ä¹ˆä¸€è¡Œä»£ç æ€ä¹ˆå°±èƒ½è¿½è¸ªäº†å‘¢ï¼Ÿ</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">let</span> dummy<span class="token punctuation">;</span>
<span class="token keyword">const</span> counter <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>dummy <span class="token operator">=</span> counter<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dummy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>çœ‹ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œå½“æ³¨å†Œ effect å‡½æ•°æ—¶ ï¼Œeffect å†…éƒ¨ä¼šç«‹å³æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå¹¶æŠŠè¿™ä¸ªå‡½æ•°å­˜å‚¨åœ¨å…¨å±€å˜é‡ activeEffect ä¸­ä½œä¸ºå½“å‰æ­£åœ¨è¿è¡Œçš„å‡½æ•°ï¼Œeffect å‡½æ•°è°ƒç”¨åˆ°äº† counter.num ä¹Ÿå°±è§¦å‘äº† handler ä¸­çš„ get æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ createGetterï¼Œtrack æ–¹æ³•å°±ä¼šæŠŠ activeEffect å’Œ counter.num å…³è”èµ·æ¥ï¼Œå¯¹è±¡å±æ€§ä¸ effect å‡½æ•°çš„ä¾èµ–å…³ç³»ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å˜é‡ targetMap ä¸­ï¼Œtrack çš„å®ç°ä¼šåœ¨åæ–‡è®²è§£ã€‚</p> <h3 id="createsetter"><a href="#createsetter" class="header-anchor">#</a> createSetter</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">createSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token keyword">set</span><span class="token punctuation">(</span>
    <span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span>
    key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span>
    value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
    receiver<span class="token operator">:</span> object</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> oldValue <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœvalueå·²ç»æ˜¯ä¸ªä»£ç†å¯¹è±¡ï¼Œåˆ™è¿˜åŸæˆåŸå§‹å¯¹è±¡</span>
    value <span class="token operator">=</span> <span class="token function">toRaw</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> hadKey <span class="token operator">=</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>åœ¨ get ä¸­å·²ç»æ”¶é›†äº†ä¾èµ–å…³ç³»å¹¶å­˜å‚¨åœ¨äº† targetMap ä¸­ï¼Œé‚£åœ¨ set ä¸­çš„é€»è¾‘å°±å¾ˆå¥½ç†è§£äº†ï¼Œåªè¦è§¦å‘å¯¹è±¡å±æ€§æ‰€ä¾èµ–çš„ effect å‡½æ•°å°±å¯ä»¥äº†ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ trigger æ–¹æ³•ã€‚vue åœ¨è§¦å‘å‰ä¼šå…ˆåˆ¤æ–­è¿™ä¸ªå±æ€§æ˜¯æ–°åŠ çš„è¿˜æ˜¯å·²æœ‰çš„ï¼Œå¦‚æœæ˜¯å·²æœ‰çš„ä¼šå†åˆ¤æ–­æ˜¯å¦æ”¹å˜äº†ã€‚</p> <h2 id="effect-ts"><a href="#effect-ts" class="header-anchor">#</a> effect.ts</h2> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> effect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> ReactiveEffectOptions <span class="token operator">=</span> <span class="token constant">EMPTY_OBJ</span>
<span class="token punctuation">)</span><span class="token operator">:</span> ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç«‹å³æ‰§è¡Œ</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> createReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> ReactiveEffectOptions
<span class="token punctuation">)</span><span class="token operator">:</span> ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">reactiveEffect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> ReactiveEffect<span class="token punctuation">;</span>
  <span class="token comment">// æŠŠä¸‹é¢è¿™äº›æ•°æ®ä»¥é™æ€å±æ€§çš„å½¢å¼åŠ åœ¨effectä¸­ï¼Œä¾¿äºä»¥åçš„è®¿é—®</span>
  effect<span class="token punctuation">.</span>_isEffect <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  effect<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  effect<span class="token punctuation">.</span>raw <span class="token operator">=</span> fn<span class="token punctuation">;</span>
  effect<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  effect<span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token keyword">return</span> effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">,</span> fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>effectStack<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// è®¾ç½®shouldTrack=trueï¼Œvueä½¿ç”¨shouldTrackæ¥æŠŠtrackçš„æœ‰æ•ˆèŒƒå›´æ§åˆ¶åœ¨effctæ–¹æ³•æ‰§è¡Œçš„å‰åï¼Œé˜²æ­¢æ„å¤–track</span>
      <span class="token function">enableTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      activeEffect <span class="token operator">=</span> effect<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// è®¾ç½®shouldTrack=false</span>
      <span class="token function">resetTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">[</span>effectStack<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>å­¦åˆ°äº†ï¼ŒåŸæ¥å¯ä»¥åˆ©ç”¨ try finally åœ¨ return ä¹‹åæ‰§è¡Œä»£ç ã€‚</p></div> <p>å†æ¥çœ‹ effect çš„å®ç°ï¼Œä¸Šè¿°ä»£ç ä¸­çš„ effect å’Œ createReactiveEffect éƒ½å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œå¹¶æŠŠä¸€äº›å¤‡ç”¨ä¿¡æ¯é™æ€ç»‘å®šåœ¨é«˜é˜¶å‡½æ•°ä¸­ï¼Œä¸è¿‡ run è¿™ä¸ªæ–¹æ³•ä¸ºå•¥é‚£ä¹ˆå¤æ‚ï¼ŸæŒ‰é“ç†åªéœ€è¦æ‰§è¡Œä¸€ä¸‹ fn å‡½æ•°å°±å¯ä»¥äº†å‘€ï¼å…¶å®æ˜¯ vue ä¸ºäº†å¤„ç†å†…åµŒ effect æ‰è¿™æ ·çš„ï¼Œæ¯”å¦‚ï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>æ­£å¸¸æ¥è®²ï¼Œåªéœ€è¦åƒä¸‹é¢è¿™æ ·å°±å¯ä»¥äº†ï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">,</span> fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> args<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">unknown</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    activeEffect <span class="token operator">=</span> effect<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    activeEffect <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="track"><a href="#track" class="header-anchor">#</a> track</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">type</span> Dep <span class="token operator">=</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> KeyToDepMap <span class="token operator">=</span> Map<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> Dep<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> KeyToDepMap<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token operator">:</span> TrackOpTypes<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// vueä½¿ç”¨shouldTrackæ¥æŠŠtrackçš„æœ‰æ•ˆèŒƒå›´æ§åˆ¶åœ¨effctæ–¹æ³•æ‰§è¡Œçš„å‰åï¼Œé˜²æ­¢æ„å¤–track</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldTrack <span class="token operator">||</span> activeEffect <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå½“å‰æ‰§è¡Œeffectä¸ºundefinedï¼Œä¹Ÿå°±æ²¡å¿…è¦trackäº†</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç¬¬ä¸€æ¬¡å…³è”è¯¥å¯¹è±¡åˆ™æ–°å»º</span>
    targetMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>dep <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç¬¬ä¸€æ¬¡å…³è”è¯¥å¯¹è±¡çš„è¯¥å±æ€§åˆ™æ–°å»º</span>
    depsMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// å¦‚æœå·²ç»trackè¿‡äº†å°±ä¸trackäº†</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>track çš„ä»£ç ä¸Šæ–‡å·²ç»æåˆ°è¿‡äº†ï¼Œå°±æ˜¯æŠŠå¯¹è±¡å±æ€§ä¸ effect å‡½æ•°çš„ä¾èµ–å…³ç³»å­˜å‚¨åˆ°å…¨å±€å˜é‡ targetMap ä¸­ï¼ŒtargetMap çš„æ•°æ®ç»“æ„å¯ä»¥å‚è€ƒ ts çš„ç±»å‹å®šä¹‰ï¼ŒtargetMap ç”¨çš„æ˜¯ WeakMapï¼Œvue æºç ä¸­çš„ç”¨æ¥å…¨å±€å­˜å‚¨çš„æ•°æ®ç»“æ„å¤§å¤šé€‰æ‹© WeakMap æˆ– WeakSetï¼Œè¿™æ˜¯å› ä¸º WeakMap å’Œ WeakSet å†…éƒ¨æ˜¯å¼±å¼•ç”¨ï¼Œä¸ä¼šå¢åŠ åƒåœ¾å›æ”¶çš„è®¡æ•°ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p> <h3 id="trigger"><a href="#trigger" class="header-anchor">#</a> trigger</h3> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token operator">:</span> object<span class="token punctuation">,</span>
  <span class="token keyword">type</span><span class="token operator">:</span> TriggerOpTypes<span class="token punctuation">,</span>
  key<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  newValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldValue<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  oldTarget<span class="token operator">?</span><span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span> <span class="token operator">|</span> Set<span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>depsMap <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ²¡æœ‰æ‰¾åˆ°ä¾èµ–ç›´æ¥è¿”å›</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// æ”¶é›†å…³è”çš„effect</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ”¶é›†å…³è”çš„computed</span>
  <span class="token keyword">const</span> computedRunners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">CLEAR</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è§¦å‘ä»£ç†å¯¹è±¡çš„æ‰€æœ‰effect</span>
    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">dep</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">addRunners</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> computedRunners<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&quot;length&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">&quot;length&quot;</span> <span class="token operator">||</span> key <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>newValue <span class="token keyword">as</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addRunners</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> computedRunners<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“æ˜¯SETã€ADDã€DELETEæ—¶ï¼Œè§¦å‘å•ä¸ªkeyå¯¹åº”çš„effect</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">addRunners</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> computedRunners<span class="token punctuation">,</span> depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// å½“æ˜¯ADDã€DELETEã€Map.SETæ˜¯ï¼Œè§¦å‘iteration keyå¯¹åº”çš„effect</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token keyword">type</span> <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">ADD</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">DELETE</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token operator">===</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span> <span class="token operator">&amp;&amp;</span> target <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> iterationKey <span class="token operator">=</span> <span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;length&quot;</span> <span class="token operator">:</span> <span class="token constant">ITERATE_KEY</span><span class="token punctuation">;</span>
      <span class="token function">addRunners</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> computedRunners<span class="token punctuation">,</span> depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>iterationKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">effect<span class="token operator">:</span> ReactiveEffect</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">scheduleRun</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span> target<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿™é‡Œè¦å…ˆè¿è¡ŒcomputedRunnersï¼Œå› ä¸ºeffectå‡½æ•°ä¸­å¯èƒ½ä¼šç”¨åˆ°computedï¼Œæ‰€ä»¥è¦ä¿è¯computedçš„æ­£ç¡®æ€§</span>
  computedRunners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
  effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">addRunners</span><span class="token punctuation">(</span>
  <span class="token parameter">effects<span class="token operator">:</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  computedRunners<span class="token operator">:</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  effectsToAdd<span class="token operator">:</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effectsToAdd <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effectsToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">effect</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœä¾èµ–çš„effectæ˜¯å½“å‰è¿è¡Œçš„activeEffectï¼Œå°±ä¼šé™·å…¥æ­»å¾ªç¯ï¼Œæ‰€ä»¥è¦æ’é™¤</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect <span class="token operator">||</span> <span class="token operator">!</span>shouldTrack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// computedå†…éƒ¨ç”¨çš„å°±æ˜¯effectï¼Œå¹¶ç”±options.computedæ¥æ ‡è¯†è¿™æ˜¯computedï¼Œè¿™é‡ŒæŠŠå¯¹åº”çš„</span>
        <span class="token comment">// runneråŠ åˆ°computedRunnersä¸­è¿è¡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          computedRunners<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">scheduleRun</span><span class="token punctuation">(</span>
  <span class="token parameter">effect<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">,</span>
  target<span class="token operator">:</span> object<span class="token punctuation">,</span>
  <span class="token keyword">type</span><span class="token operator">:</span> TriggerOpTypes<span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span>
  extraInfo<span class="token operator">?</span><span class="token operator">:</span> DebuggerEventExtraInfo</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>scheduler <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">scheduler</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><p>trigger æ–¹æ³•ç›¸å…³ä»£ç é‚£ä¹ˆå¤šï¼Œå…¶å®åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯ä»å…¨å±€å˜é‡ targetMap ä¸­åˆ†ææ‰¾åˆ°å½“å‰è¦è§¦å‘çš„ï¼ŒåŠ åˆ°é˜Ÿåˆ—å¹¶æ‰§è¡Œå®ƒã€‚ä»£ç èŠ±äº†ä¸€ç‚¹ç¯‡å¹…æ¥æ ¹æ®ä¸åŒçš„è§¦å‘ç±»å‹å’Œä¸åŒçš„ target ç±»å‹æ¥åšä¸åŒçš„å¤„ç†ï¼Œä»¥ä¿è¯æ”¯æŒæ•°ç»„ã€é›†åˆç±»å‹ã€‚ä»ä»£ç  63 è¡Œæˆ‘ä»¬å¯ä»¥å‘ç° computed å…¶å®å°±æ˜¯æ‰“äº† computed æ ‡è¯†çš„ effectã€‚</p> <p>è‡³æ­¤ reactive å’Œ effect ä¸¤ä¸ªæ¨¡å—éƒ½è®²å®Œäº†ï¼Œå†æ€»ç»“ä¸€ä¸‹ï¼Œreactive è´Ÿè´£åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡ä¼šä»£ç† getã€setã€deleteProperty ç­‰æ“ä½œï¼Œeffect è´Ÿè´£æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°ï¼Œåœ¨æ‰§è¡Œè¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°æ—¶ä¼šæ”¶é›†ä¾èµ–ï¼Œåœ¨ä¿®æ”¹å¯¹è±¡å±æ€§æ—¶è§¦å‘ä¾èµ–ã€‚ä¸‹å›¾ç®€å•çš„æç»˜äº†å“åº”å¼çš„è¿‡ç¨‹ï¼š
<img src="/assets/img/vue_reactivity.4e3294b3.png" alt=""></p> <h2 id="computed-ts"><a href="#computed-ts" class="header-anchor">#</a> computed.ts</h2> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> computed<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  getterOrOptions<span class="token operator">:</span> ComputedGetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> WritableComputedOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> getter<span class="token operator">:</span> ComputedGetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> setter<span class="token operator">:</span> ComputedSetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>getterOrOptions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    getter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">;</span>
    setter <span class="token operator">=</span> __DEV__
      <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Write operation failed: computed value is readonly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token operator">:</span> <span class="token constant">NOOP</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    getter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">;</span>
    setter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> computed<span class="token operator">:</span> ComputedRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// ç”¨æ¥æ ‡è®°è¿™ä¸ªeffectæ˜¯computed</span>
    computed<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// åœ¨triggeræ—¶ï¼Œschedulerä¼šæ›¿ä»£effectå‡½æ•°æ¥æ‰§è¡Œ</span>
    <span class="token function-variable function">scheduler</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">trigger</span><span class="token punctuation">(</span>computed<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  computed <span class="token operator">=</span> <span class="token punctuation">{</span>
    _isRef<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    effect<span class="token operator">:</span> runner<span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token function">runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// åº”å¯¹åœ¨effectå‡½æ•°ä¸­ä½¿ç”¨computedçš„åœºæ™¯</span>
      <span class="token function">track</span><span class="token punctuation">(</span>computed<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newValue<span class="token operator">:</span> <span class="token constant">T</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setter</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> computed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br></div></div><p>æˆ‘ä»¬å¯ä»¥å€ŸåŠ©å•å…ƒæµ‹è¯•æ¥è¾…åŠ©ç†è§£ï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> plusOne <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>plusOne<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
n<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>plusOne<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>åœ¨ vue 3 ä¸­ computed æ˜¯ä¸€ä¸ªåŒ…å« value å€¼çš„å¯¹è±¡ï¼Œä»æºç ä¸­å¾—çŸ¥ computed æ–¹æ³•å‚æ•°æ”¯æŒä¸€ä¸ªæ–¹æ³•æˆ–ä¸€ä¸ªåŒ…å« getã€set çš„å¯¹è±¡ï¼Œå‰è€…å¯¹åº”åè€…çš„ getã€‚computed å†…éƒ¨ä½¿ç”¨çš„ effect æ˜¯ lazy æ¨¡å¼ï¼ˆ24 è¡Œï¼‰ï¼Œlazy æ¨¡å¼ä¸‹åœ¨åˆ›å»º effect æ—¶ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œå¹¶ä¸”å®šä¹‰äº† scheduler æ–¹æ³•ï¼ˆ28 è¡Œï¼‰ï¼Œè¿™ä¸ª scheduler æ–¹æ³•ä¼šåœ¨ä»£ç†å¯¹è±¡å‘ç”Ÿå˜åŒ–å¹¶è§¦å‘å‰¯ä½œç”¨å‡½æ•°æ—¶å–ä»£åè€…è€Œæ‰§è¡Œï¼Œæ•ˆæœå°±æ˜¯å½“ä¾èµ–å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œeffect å‡½æ•°ä¸ä¼šæ‰§è¡Œï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ‰§è¡Œ scheduler æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿ</p> <ul><li>ä¸€ä¸ªç›®çš„æ˜¯ä¸ºäº†å–æ¶ˆåŸæœ¬æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œï¼Œæˆ‘ä»¬çŸ¥é“å•ç‹¬ä½¿ç”¨ effect æ—¶ï¼Œåªè¦å…¶ä¾èµ–å¯¹è±¡å‘ç”Ÿå˜åŒ–åä¼šéšå³æ‰§è¡Œï¼Œä½†æ˜¯ä½œä¸º computed å¯¹è±¡ï¼Œå¹¶ä¸éœ€è¦ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åº”åœ¨è®¿é—® computed å¯¹è±¡æ—¶æ‰éœ€è¢«æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯åœ¨ä»£ç  40 è¡Œæ‰‹åŠ¨æ‰§è¡Œäº†å‰¯ä½œç”¨å‡½æ•°å¹¶æŠŠç»“æœè¿”å›ã€‚æœ€åæˆ‘ä»¬å‘ç°ï¼Œæ ¹æ®ä¾èµ–å¯¹è±¡å˜åŒ–è‡ªåŠ¨æ‰§è¡Œçš„ effect è‡ªä»æ‰“ä¸Šäº† computed æ ‡è®°åï¼ˆ26 è¡Œï¼‰ï¼Œå°±å˜æˆäº†æŒ‰éœ€æ‰§è¡Œã€‚</li> <li>å¦ä¸€ä¸ªç›®çš„æ˜¯ä¸ºäº†å¤„ç†åœ¨ effect æ³¨å†Œå‡½æ•°ä¸­è®¿é—® computed å¯¹è±¡çš„åœºæ™¯ï¼Œç†æƒ³æ•ˆæœåº”è¯¥æ˜¯ computed å¯¹è±¡æ‰€ä¾èµ–çš„å¯¹è±¡å‘ç”Ÿå˜åŒ–åï¼Œè¿™ä¸ªä½¿ç”¨äº† computed å¯¹è±¡çš„å‰¯ä½œç”¨å‡½æ•°ä¼šè¢«è‡ªåŠ¨æ‰§è¡Œã€‚</li></ul> <p>æ¥ç€ä¸Šè¿°çš„ç¬¬äºŒä¸ªç›®çš„ï¼Œä¹Ÿè®¸æœ‰äººæ³¨æ„åˆ°åœ¨æºç  44 è¡Œè°ƒç”¨äº† trackï¼Œåœ¨ 31 è¡Œè°ƒç”¨äº† trigger æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ track æ˜¯ä¸ºäº†ç»‘å®šè¢«è®¿é—®å¯¹è±¡ä¸å½“å‰æ­£åœ¨æ‰§è¡Œçš„ effect çš„å…³ç³»çš„ï¼Œè€Œ effect åœ¨ 40 è¡Œå°±å·²ç»æ‰§è¡Œå®Œäº†ï¼Œå¾ˆæ˜¾ç„¶æ­¤æ—¶ activeEffect=undefinedï¼Œæˆ‘ä»¬å†ä»¥ä¸Šé¢è¿™ä¸ªå•å…ƒæµ‹è¯•ä¸ºå…¥å£è¿›è¡Œ debug æ¥éªŒè¯ä¸‹ï¼Œå‘ç°ç¡®å®è¿™è¡Œ track ä»£ç æ²¡æœ‰å‘æŒ¥ä½œç”¨ï¼Œåœ¨åš activeEffect éç©ºåˆ¤æ–­æ—¶å°± return äº†ã€‚</p> <p>è¿™çœ‹ä¼¼æ²¡æœ‰å‘æŒ¥ä½œç”¨çš„ä»£ç ä¸ºä»€ä¹ˆä¼šå­˜åœ¨å‘¢ï¼Ÿå…¶å®åªæ˜¯å› ä¸ºä¸Šé¢çš„å•å…ƒæµ‹è¯•æ²¡æœ‰è¦†ç›–åˆ°èƒ½ä½¿å…¶å‘æŒ¥ä½œç”¨çš„åœºæ™¯ç½¢äº†ã€‚æˆ‘ä»¬æŠŠå•å…ƒæµ‹è¯•æ”¹æˆå¦‚ä¸‹ï¼š</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> n <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> plusOne <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> plusTwo <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> plusOne<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>plusOne<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>plusTwo<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
n<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>plusOne<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>plusTwo<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>ä¸Šé¢è¿™ä¸ªå•å…ƒæµ‹è¯•åœ¨ effect ä¸­è®¿é—®äº† computed å¯¹è±¡ plusOneï¼Œç„¶å debug å°±å‘ç° 44 è¡Œçš„ track æŠŠ plusOne.value å’Œ<code>() =&gt; plusOne.value + 2</code>å‡½æ•°å»ºç«‹äº†ä¾èµ–å…³ç³»ï¼Œä»è€Œå®ç°äº†ä¸Šè¿°çš„ç¬¬äºŒä¸ªç›®çš„ã€‚</p> <h2 id="ref-ts"><a href="#ref-ts" class="header-anchor">#</a> ref.ts</h2> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">createRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createRef</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> shallow <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shallow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    value <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> r <span class="token operator">=</span> <span class="token punctuation">{</span>
    _isRef<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">track</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> TrackOpTypes<span class="token punctuation">.</span><span class="token constant">GET</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">trigger</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> TriggerOpTypes<span class="token punctuation">.</span><span class="token constant">SET</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">convert</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>ref çš„æºç å°±å¾ˆç®€å•äº†ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåªåŒ…å« value å±æ€§ä¸”ä»£ç†äº†è¿™ä¸ª value å±æ€§çš„å¯¹è±¡ï¼Œå°±ä¸åšè¿‡å¤šèµ˜è¿°äº†ã€‚</p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>è‡³æ­¤ reactiveã€effectã€computedã€ref æºç éƒ½è®²è§£å®Œæ¯•äº†ï¼Œæœ€åå†åˆ†äº«ä¸‹çœ‹æºç çš„æŠ€å·§ã€‚</p> <p>è¿™ä¸ªæŠ€å·§å°±æ˜¯ä»¥å•å…ƒæµ‹è¯•ä¸ºèµ·ç‚¹ï¼Œæ‰“æ–­ç‚¹ debugï¼Œvue 3 é…ç½®äº†åœ¨ VSCode ä¸­å¾ˆå‹å¥½çš„ debug æ–¹å¼ï¼Œåªéœ€åœ¨æºç ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œå†æ‰“å¼€å®˜æ–¹çš„å•å…ƒæµ‹è¯•æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ–°å»ºä¸€ä¸ªå•å…ƒæµ‹è¯•æ–‡ä»¶æ¥è°ƒè¯•æƒ³è¦å¼„æ¸…çš„ç‰¹æ€§çš„å®ç°åŸç†ï¼Œç„¶åç‚¹å‡» debug æŒ‰é’®å°±å¯ä»¥äº†ã€‚åœ¨é˜…è¯»æºç ä¸­ï¼Œdebug ä½¿å¾—æˆ‘ç†è§£èµ·æ¥äº‹åŠåŠŸå€ï¼Œå¤§å®¶ä¸å¦¨è¯•ä¸€è¯• ğŸ˜Šã€‚</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/article/å®ç°ä¸€ä¸ªç®€å•çš„WEBæ‰“åŒ…å·¥å…·.html" class="prev">
        å®ç°ä¸€ä¸ªç®€å•çš„WEBæ‰“åŒ…å·¥å…·
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5be931bc.js" defer></script><script src="/assets/js/2.448a10a4.js" defer></script><script src="/assets/js/8.04576c8f.js" defer></script>
  </body>
</html>
